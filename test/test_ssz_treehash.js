const assert = require('chai').assert
const BN = require('bn.js')

const hexToBytes = require('./utils/hexToBytes').hexToBytes
const treeHash = require('../src').treeHash
const merkleHash = require('../src').merkleHash
const testObjects = require('./utils/objects')

const SimpleObject = testObjects.SimpleObject
const OuterObject = testObjects.OuterObject
const InnerObject = testObjects.InnerObject
const ArrayObject = testObjects.ArrayObject


describe('SimpleSerialize - tree hashes', () => {
  const testCases = [
    // bool
    [[false, 'bool'], '0000000000000000000000000000000000000000000000000000000000000000'],
    [[true, 'bool'], '0100000000000000000000000000000000000000000000000000000000000000'],
    // uint8
    [[0, 'uint8'], "0000000000000000000000000000000000000000000000000000000000000000"],
    [[1, 'uint8'], "0100000000000000000000000000000000000000000000000000000000000000"],
    [[16, 'uint8'], "1000000000000000000000000000000000000000000000000000000000000000"],
    [[128, 'uint8'], "8000000000000000000000000000000000000000000000000000000000000000"],
    [[255, 'uint8'], "ff00000000000000000000000000000000000000000000000000000000000000"],
    // uint16
    [[0, 'uint16'], "0000000000000000000000000000000000000000000000000000000000000000"],
    [[1, 'uint16'], "0100000000000000000000000000000000000000000000000000000000000000"],
    [[16, 'uint16'], "1000000000000000000000000000000000000000000000000000000000000000"],
    [[128, 'uint16'], "8000000000000000000000000000000000000000000000000000000000000000"],
    [[255, 'uint16'], "ff00000000000000000000000000000000000000000000000000000000000000"],
    [[65535, 'uint16'], "ffff000000000000000000000000000000000000000000000000000000000000"],
    // uint32
    [[0, 'uint32'], "0000000000000000000000000000000000000000000000000000000000000000"],
    [[1, 'uint32'], "0100000000000000000000000000000000000000000000000000000000000000"],
    [[16, 'uint32'], "1000000000000000000000000000000000000000000000000000000000000000"],
    [[128, 'uint32'], "8000000000000000000000000000000000000000000000000000000000000000"],
    [[255, 'uint32'], "ff00000000000000000000000000000000000000000000000000000000000000"],
    [[65535, 'uint32'], "ffff000000000000000000000000000000000000000000000000000000000000"],
    [[4294967295, 'uint32'], "ffffffff00000000000000000000000000000000000000000000000000000000"],
    // uint64
    [[0, 'uint64'], "0000000000000000000000000000000000000000000000000000000000000000"],
    [[1, 'uint64'], "0100000000000000000000000000000000000000000000000000000000000000"],
    [[16, 'uint64'], "1000000000000000000000000000000000000000000000000000000000000000"],
    [[128, 'uint64'], "8000000000000000000000000000000000000000000000000000000000000000"],
    [[255, 'uint64'], "ff00000000000000000000000000000000000000000000000000000000000000"],
    [[65535, 'uint64'], "ffff000000000000000000000000000000000000000000000000000000000000"],
    [[4294967295, 'uint64'], "ffffffff00000000000000000000000000000000000000000000000000000000"],
    [[new BN('18446744073709551615'), 'uint64'], "ffffffffffffffff000000000000000000000000000000000000000000000000"],
    // bytes
    [[Buffer.alloc(0), 'bytes'],'e8e77626586f73b955364c7b4bbf0bb7f7685ebd40e852b164633a4acbd3244c'],
    [[Buffer.from([1]), 'bytes'], 'b2559fed89f0ec17542c216683dc6b75506f3754e0c045742936742cae6343ca'],
    [[Buffer.from([1, 2, 3, 4, 5, 6]), 'bytes'], '1310542d28be8e0b3ff72e985bc06232b9a30d93ae1ad2e33c5383a54ab5c9a7'],
    // array
    [[[], ['uint16']], 'dfded4ed5ac76ba7379cfe7b3b0f53e768dca8d45a34854e649cfc3c18cbd9cd'],
    [[[1], ['uint16']], 'c06186a930277b15545e5b499386cb8f1f03028c080ae5b1542d9e40d52098e5'],
    [[[1, 2], ['uint16']], 'da760e411ffbada0568ea1a2f6adedde9534ed86320cf87703800a5c3332ce32'],
    [[[[1,2,3,4],[5,6,7,8]], [['uint16']]], '6dbe0a9d5becd51d752bb3af7422a7970ec94174013f9667a516b1a07c55fea7'],
    // object
    [[{b:0,a:0}, SimpleObject], '99ff0d9125e1fc9531a11262e15aeb2c60509a078c4cc4c64cefdfb06ff68647'],
    [[{b:2,a:1}, SimpleObject], 'd2b49b00c76582823e30b56fe608ff030ef7b6bd7dcc16b8994c9d74860a7e1c'],
    [[{v:3,subV: {v:6}}, OuterObject], 'bb2f30386c55445381eee7a33c3794227b8c8e4be4caa54506901a4ddfe79ee2'],
    [[{v: [{b:2,a:1}, {b:4,a:3}]}, ArrayObject], '2da34dd1d08d6b11ede0e3b0193b30f44dac334943304936767a2baca201dfb2'],
    [[[{v:3, subV:{v:6}}, {v:5, subV:{v:7}}], [OuterObject]], '95fb2ae53e7b7b91d11b76456f2be2934477f298dfe7717af86c6922e8fada5f'],
  ];

  const stringifyType = type => {
    if (typeof type === 'string') {
      return type
    } else if (Array.isArray(type)) {
      return `[${stringifyType(type[0])}]`
    } else if (typeof type === 'function') {
      return type.name
    } else return ''
  };

  for (const [input, output] of testCases) {
    const [value, type] = input;
    it(`successfully tree hashes ${stringifyType(type)}`, () => {
      assert.equal(treeHash(value, type).toString('hex'), output)
    })
  }
});

describe('SimpleSerialize - merkle hashes', () => {
  const testCases = [
    [[], 'dfded4ed5ac76ba7379cfe7b3b0f53e768dca8d45a34854e649cfc3c18cbd9cd'],
    [[Buffer.from([1,2]), Buffer.from([3,4])], '82ebb0994e3eb23d08ec5d00415de7b14ff8f21e34396710f561b6ab4e83bd24'],
    [[1,2,3,4,5,6,7,8,9,10].map(i => Buffer.alloc(16,i)), '29f50926f6e96cd360b39ecc55d0b29cb9a6c28bb2960df801c5353b3ddd249c'],
    [[1,2,3,4,5,6,7,8,9,10].map(i => Buffer.alloc(32,i)), '9b40b5dd36ee986ffaa104a8ffe2492fdd79d433ebf0702075fa7d6d557b6cdd'],
  ]
  for (const [input, output] of testCases) {
    it('successfully merkle hashes', () => {
      assert.equal(merkleHash(input).toString('hex'), output)
    })
  }
})

